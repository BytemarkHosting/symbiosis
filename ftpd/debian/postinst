#!/bin/bash

set -e

#
# Skip, if we are not in "configure" state
#
if [ "$1" != "configure" ]; then
        echo "I: Skipping configuration"
        exit 0
fi

# If this is a new setup...
if [ "$2" = "" ] ; then
	#
	#  Then remove existing PAMAuthentication setup,
	#
	find /etc/pure-ftpd/auth/ -lname "*/PAMAuthentication"  -exec rm -f \{\} \;
	find /etc/pure-ftpd/auth/ -lname "*/UnixAuthentication" -exec rm -f \{\} \;
fi

#
# Always reconfigure to allow external authentication.
# 
find /etc/pure-ftpd/auth/ -lname "*/ExtAuth" -exec rm -f \{\} \;
ln -sf /etc/pure-ftpd/conf/ExtAuth /etc/pure-ftpd/auth/60ext

#
#
#
#
#  Always show dotfiles.
#
echo "yes" > /etc/pure-ftpd/conf/DisplayDotFiles

#
#  Use our authentication method
#
echo "/var/run/pure-ftpd/pure-authd.sock" > /etc/pure-ftpd/conf/ExtAuth

#
#  Make sure we have a certificate directory.
#
if [ ! -d /etc/ssl/private ]; then
    mkdir -p /etc/ssl/private
fi


#
#  If we dont have an SSL certificate generate one.
#
if [ ! -e /etc/ssl/ssl.combined ]; then

    #
    #  Make it.
    #
    openssl req  -subj "/C=GB/ST=North Yorkshire/L=York/CN=$(cat /etc/hostname)" -new -x509 -days 3650 -nodes -out  /etc/ssl/ssl.pem -keyout /etc/ssl/ssl.key

    #
    #  Combine PEM + Key
    #
    cat /etc/ssl/ssl.key /etc/ssl/ssl.pem > /etc/ssl/ssl.combined
fi

#
#  Link in the certificate if we have one.
#
if [ ! -e /etc/ssl/private/pure-ftpd.pem ]; then

    ln -s /etc/ssl/ssl.combined /etc/ssl/private/pure-ftpd.pem

fi

#
#  TLS should be enabled if we did the linking.
#
echo '1' > /etc/pure-ftpd/conf/TLS

#
# Update default runlevels.
#
if [ -x "/etc/init.d/pure-authd" ]; then
  update-rc.d pure-authd defaults >/dev/null
fi


#
#  Restart (or start)
#
if [ "$2" = "" ] ; then
  action=start
else
  action=restart
fi

if which invoke-rc.d >/dev/null 2>&1; then
    invoke-rc.d pure-authd $action
else
    /etc/init.d/pure-authd $action
fi

#DEBHELPER#
exit 0
