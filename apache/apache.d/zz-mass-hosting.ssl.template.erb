###
##
#
#  This file is automatically generated from the template located at
#  /etc/symbiosis/apache.d/zz-mass-hosting.ssl.template.erb.
#
#  Feel free to make changes to this file.  If changes are made, then this file
#  will not be updated automatically when the template changes.
#
##
###

% ips.each do |ip|
NameVirtualHost <%= ip %>:443
% end 

<VirtualHost <%= ips.collect{|ip| ip+":443"}.join(" ") %>> 

        #
        #  Ensure that the SSL options are configured.
        #
        SSLEngine On
        <%= ssl_config %>

        #
        # Sane SSL ciphers.
        #
        SSLCipherSuite TLSv1:!LOW:!EXP:!aNULL:!eNULL

        #
        # And some options
        #
        SSLOptions +StrictRequire

        #
        #  This is the directory people are redirected to
        # if their site is empty.
        #
        Alias /bytemark/ "/usr/share/symbiosis/static/"
        <Directory "/usr/share/symbiosis/static/">
                DirectoryIndex index.html
                AllowOverride All
        </Directory>

        #
        #  And this makes that redirection happen.
        #
        <LocationMatch "^/+$">
                Options -Indexes
                ErrorDocument 403 /bytemark/
        </LocationMatch>


        #
        #  Allow users to override settings via .htaccess
        #
        <Directory "/srv">
                AllowOverride all
        </Directory>


        #
        #  We will allow global CGIs without any effort though.
        #
        AddHandler cgi-script .cgi


        #
        #  Disable the "single" name for this server.
        #
        UseCanonicalName        Off


        #
        #  Aliases for testing sites prior to DNS migration.
        #
        RewriteEngine On
        RewriteCond %{HTTP_HOST} ^(.*)\.testing\.(.*)$
        RewriteRule ^/(.*)$  /srv/%1/public/htdocs/$1


        #
        #  The document root + CGI-directories.
        #
        VirtualDocumentRoot     /srv/%0/public/htdocs/
        VirtualScriptAlias      /srv/%0/public/cgi-bin/


        #
        # Update documentroot settings for each vhost.
        #
        SetVirtualDocumentRoot on

        #
        #  We need to log the virtual hostname the incoming request was
        # made against, so that the cron-job in /etc/cron.daily may generate
        # statistics for each domain.
        #
        LogFormat "%V %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" zz_mass_hosting_combined
        CustomLog "|| /usr/sbin/symbiosis-apache-logger -s -l ssl_access.log /var/log/apache2/zz-mass-hosting.ssl_access.log" zz_mass_hosting_combined
        ErrorLog  /var/log/apache2/zz-mass-hosting.error.log
</VirtualHost>

