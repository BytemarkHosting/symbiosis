####
##
#
#  This file is automatically generated from the template located at
#  /etc/symbiosis/apache.d/ssl.template.erb.
#
#  Feel free to make changes to this file, and thereafter it will not be
#  automatically updated if the template, or SSL configuration changes.
#
#  For SSL documenation please consult:
#
#  http://symbiosis.bytemark.co.uk/squeeze/docs/ch-ssl-hosting.html
#
##
###

<VirtualHost <%= ips.collect{|ip| ip+":443"}.join(" ") %>>

        #
        # Put our server name 
        #
        ServerName  <%= domain %>

        #
        # This is the testing alias.
        #
        ServerAlias <%= domain %>.testing.<%= hostname() %>

        #
        # And server alias in place
        #
        <%= server_aliases %>


        <IfModule ssl_module>
                SSLEngine On

                #
                # The certificate, key, and intermediate bundle (if needed)
                #
                <%= ssl_config %>


                #
                # Sane SSL ciphers.
                #
                SSLCipherSuite ALL:!LOW:!SSLv2:!EXP:!aNULL

                #
                # Ban ancient protocols
                #
                SSLProtocol ALL -SSLv2 -SSLv3

                #
                # And some options
                #
                SSLOptions +StrictRequire
        </IfModule>

        #
        #  Allow users to override settings via .htaccess
        #
        <Directory <%=domain_directory%> >
                AllowOverride all
                Require all granted
        </Directory>

        #
        #  The document root
        #
        DocumentRoot <%= htdocs_directory %>/

        <IfModule cgi_module>
                #
                # General CGI Handling
                #
                ScriptAlias /cgi-bin/ <%= cgibin_directory %>/

                <Location /cgi-bin>
                        Options +ExecCGI
                </Location>
        </IfModule>

        #
        # Disable indexes by default on the top-level.
        #
        <LocationMatch "^/+$">
                Options -Indexes
        </LocationMatch>

% if mandatory_ssl?
        <IfModule headers_module>
                Header always setifempty Strict-Transport-Security â€œmax-age=86400"
        </IfModule>
% end

        #
        # We need to log the virtual hostname the incoming request was
        # made against, so that the cron-job in /etc/cron.daily may generate
        # statistics for each domain.
        #
        ErrorLog   "|| /usr/sbin/symbiosis-httpd-logger -s -u <%= domain.uid %> -g <%= domain.gid %> <%= domain.log_dir %>/ssl_error.log"
        CustomLog  "|| /usr/sbin/symbiosis-httpd-logger -s -u <%= domain.uid %> -g <%= domain.gid %> <%= domain.log_dir %>/ssl_access.log" combined
</VirtualHost>

<VirtualHost <%= ips.collect{|ip| ip+":80"}.join(" ") %>>

        #
        # Put our server name 
        #
        ServerName  <%= domain %>

        #
        # This is the testing alias.
        #
        ServerAlias <%= domain %>.testing.<%= hostname() %>

        #
        # And server alias in place
        #
        <%= server_aliases %>

% if mandatory_ssl?
        <IfModule alias_module>
                #
                #  All accesses redirect to the HTTPS version of
                # the site.
                #
                Redirect / https://<%= domain %>/
        </IfModule>
% else

        #
        #  Allow users to override settings via .htaccess
        #
        <Directory <%=domain_directory%> >
                AllowOverride all
        </Directory>

        #
        #  The document root
        #
        DocumentRoot     <%= htdocs_directory %>/

        <IfModule cgi_module>
                #
                # General CGI Handling
                #
                ScriptAlias /cgi-bin/ <%= cgibin_directory %>/

                <Location /cgi-bin>
                        Options +ExecCGI
                </Location>
        </IfModule>
        
        #
        # Disable indexes by default 
        #
        <LocationMatch "^/+$">
                Options -Indexes
        </LocationMatch>

        #
        #  We need to log the virtual hostname the incoming request was
        # made against, so that the cron-job in /etc/cron.daily may generate
        # statistics for each domain.
        #
        ErrorLog   "|| /usr/sbin/symbiosis-httpd-logger -s -u <%= domain.uid %> -g <%= domain.gid %> <%= domain.log_dir %>/error.log"
        CustomLog  "|| /usr/sbin/symbiosis-httpd-logger -s -u <%= domain.uid %> -g <%= domain.gid %> <%= domain.log_dir %>/access.log" combined

% end
</VirtualHost>

