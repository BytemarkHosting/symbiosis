#!/usr/bin/ruby
#
# NAME
#
#  symbiosis-test - Test systems' functionality running under Symbiosis
#
# SYNOPSIS
#
#  symbiosis-test [ --help ] [ --verbose ] [directory]
#
# AUTHOR
#
#  Patrick J. Cherry <patrick@bytemark.co.uk>
#


#
#  Run all tests.
#


require 'getoptlong'

opts = GetoptLong.new(
         [ '--help', '-h', GetoptLong::NO_ARGUMENT ],
         [ '--verbose', '-v', GetoptLong::NO_ARGUMENT ]
       )

opts.each do |opt, arg|
  case opt
  when '--help'
    $HELP = true
  when '--verbose'
    $VERBOSE = true
  end
end

#
# CAUTION! Here be quality kode.
#
if $HELP
  # Open the file, stripping the shebang line
  lines = File.open(__FILE__){|fh| fh.readlines}[2..-1]

  lines.each do |line|
    line.chomp!
    break if line.empty?
    puts line[2..-1].to_s
  end

  exit 0
end

#
# This require is here to allow manpage generation without it.
#
require 'test/unit'
require 'fileutils'

if ARGV.empty?
  dir = '/etc/symbiosis/test.d'
else
  dir = File.expand_path(ARGV.shift)
end

FileUtils.chdir(dir)

Dir.glob(File.join(dir,"t*.rb")).each do |test|
  require test
end

