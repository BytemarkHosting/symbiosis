#!/bin/bash
#

set -e

#
# Skip, if we are not in "configure" state
#
if [ "$1" != "configure" ]; then
        echo "I: Skipping configuration"
        exit 0
fi

#
# Double check this file gets installed with the correct permissions
#
if ( ! dpkg-statoverride --list /etc/sudoers.d/symbiosis > /dev/null ) ; then
  dpkg-statoverride --add --update root root 0440 /etc/sudoers.d/symbiosis
fi

#
# Shadow passwords must be on.
#
shadowconfig on

#
#  If there isn't an admin account add it.
#
if ( ! grep ^admin: /etc/passwd 2>/dev/null >/dev/null ); then

  echo "Adding 'admin' account"
  adduser --home=/srv --shell=/bin/bash --no-create-home --disabled-login --gecos='Symbiosis Administrator,,,' admin

  #
  #  Now set the password for admin to that used by root if it isn't there
  #
  usermod -p "$(grep root /etc/shadow | cut -f 2 -d :)" admin

  #
  #  If we have an adm group - which we shold - add the admin user to it.
  #
  if ( getent group adm >/dev/null ); then
    adduser admin adm > /dev/null
  fi
fi

#
# Add a stat override for the /srv directory.
#
if ( ! dpkg-statoverride --list /srv > /dev/null ) ; then
  dpkg-statoverride --add --update admin admin 2755 /srv
fi

#
# Find the hostname, if not set already.
#
if [ -z "$HOSTNAME" ] ; then
  if [ -f /etc/hostname ] ; then
    HOSTNAME=$(< /etc/hostname)
  else
    HOSTNAME=$(hostname --fqdn)
  fi
fi

#
#  If there are no existing directories beneath /srv/ create a default.
#
if [ -n "$HOSTNAME" -a "$(find /srv -maxdepth 1 -mindepth 1 -type d | wc -l)" = "0" ] ; then
  #
  # Create the standard directories
  #
  mkdir -p /srv/$HOSTNAME/public/htdocs
  mkdir -p /srv/$HOSTNAME/config
  mkdir -p /srv/$HOSTNAME/mailboxes/root

  chown -R admin:admin /srv/$HOSTNAME
fi

#
# Generate SSL certificates.
#
if ! [ -e /etc/ssl/ssl.crt -a -e /etc/ssl/ssl.key ]; then

  for i in key crt cobined ; do
    [ -e /etc/ssl/ssl.$i ] && mv /etc/ssl/ssl.$i /etc/ssl/ssl.$i.dpkg-old
  done

  if [ -n "$HOSTNAME" ] ; then
    #
    #  Make the cert + key
    #
    echo "I: Generating a new SSL certificate for $HOSTNAME"
    openssl req -subj "/C=GB/ST=England/L=York/CN=$HOSTNAME" -new -x509 -days 3650 -nodes -newkey rsa:4096 -out  /etc/ssl/ssl.crt -keyout /etc/ssl/ssl.key

    #
    #  Combine Cert + Key
    #
    cat /etc/ssl/ssl.key /etc/ssl/ssl.crt > /etc/ssl/ssl.combined
  else
    #
    # No hostname, no certificate
    #
    echo "W: Could not work out hostname to generate a self-signed SSL certificate."
  fi
fi

#DEBHELPER#

exit 0
